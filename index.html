<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Absensi Realtime</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-success { background-color: #198754; border: none; }
        .btn-success:hover { background-color: #146c43; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3" style="border-radius: 15px 15px 0 0;">
                    <h5 class="mb-0"><i class="fas fa-fingerprint me-2"></i>Data Absensi X802</h5>
                    
                    <div>
                        <button class="btn btn-sm btn-success me-2" onclick="downloadExcel()">
                            <i class="fas fa-file-excel me-1"></i> Export Excel
                        </button>
                        
                        <button class="btn btn-sm btn-light text-primary" onclick="loadData()">
                            <i class="fas fa-sync-alt" id="icon-refresh"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Waktu Scan</th>
                                    <th>ID User</th>
                                    <th>Status</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <tr><td colspan="4" class="text-center py-4">Memuat...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Fungsi Format Tanggal (Indonesia)
    function formatTanggal(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('id-ID', { 
            day: 'numeric', month: 'long', year: 'numeric', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    // 2. Fungsi Load Data Tabel (Preview 50 Data)
    async function loadData() {
        const tbody = document.getElementById('table-body');
        const icon = document.getElementById('icon-refresh');
        icon.classList.add('fa-spin');
        
        try {
            const response = await fetch('/.netlify/functions/api'); // Default limit 50
            const data = await response.json();
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Kosong.</td></tr>`;
            } else {
                data.forEach(row => {
                    let statusLabel = row.status == 0 ? '<span class="badge bg-success">Check In</span>' : 
                                      (row.status == 1 ? '<span class="badge bg-danger">Check Out</span>' : '<span class="badge bg-secondary">Log</span>');
                    
                    let ket = row.status == 0 ? 'Masuk' : (row.status == 1 ? 'Pulang' : '-');

                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4 fw-bold text-dark">${formatTanggal(row.scan_time)}</td>
                            <td>${row.finger_id}</td>
                            <td>${statusLabel}</td>
                            <td class="text-muted small">${ket}</td>
                        </tr>
                    `;
                });
            }
        } catch (error) {
            console.error(error);
        } finally {
            icon.classList.remove('fa-spin');
        }
    }

    // 3. FUNGSI DOWNLOAD EXCEL (Script Baru)
    async function downloadExcel() {
        const btn = document.querySelector('.btn-success');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        try {
            // Request ke API dengan mode=export agar dapat data lebih banyak
            const response = await fetch('/.netlify/functions/api?mode=export');
            const data = await response.json();

            if (data.length === 0) {
                alert("Tidak ada data untuk di-export.");
                return;
            }

            // A. Rapikan Data sebelum jadi Excel
            // Kita ingin header Excel-nya bahasa Indonesia, bukan nama kolom database
            const excelData = data.map(item => {
                const dateObj = new Date(item.scan_time);
                return {
                    "ID Karyawan": item.finger_id,
                    "Tanggal": dateObj.toLocaleDateString('id-ID'), // Kolom Tanggal
                    "Jam": dateObj.toLocaleTimeString('id-ID'),     // Kolom Jam
                    "Status": item.status == 0 ? "Masuk" : (item.status == 1 ? "Pulang" : "Lainnya"),
                    "Waktu Original": item.scan_time
                };
            });

            // B. Buat Workbook (File Excel Virtual)
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Absensi");

            // C. Download File
            const fileName = `Laporan_Absensi_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);

        } catch (error) {
            console.error(error);
            alert("Gagal download excel.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Load data saat pertama kali buka
    document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
